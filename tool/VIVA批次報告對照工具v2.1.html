<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NGS 多樣本分析綜合報告對照工具 v2.1</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root { --sidebar-width: 280px; }
        body { background-color: #f0f2f5; font-size: 0.82rem; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        .top-navbar { background: #2c3e50; color: white; padding: 10px 20px; z-index: 1000; flex-shrink: 0; }
        .main-wrapper { display: flex; flex: 1; overflow: hidden; }
        .sidebar { width: var(--sidebar-width); background: white; border-right: 1px solid #ddd; display: flex; flex-direction: column; flex-shrink: 0; }
        .sidebar-header { padding: 15px; border-bottom: 1px solid #eee; background: #f8f9fa; }
        .sample-list { flex: 1; overflow-y: auto; padding: 10px; }
        .sample-item { display: flex; align-items: flex-start; gap: 8px; padding: 6px; border-bottom: 1px solid #f0f0f0; }
        .sample-info { font-size: 0.72rem; color: #666; word-break: break-all; }
        .content-area { flex: 1; overflow-y: auto; padding: 20px; }
        .section-card { background: white; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 25px; padding: 15px; }
        .table-title { border-left: 4px solid #e67e22; padding-left: 10px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; }
        .table-container { position: relative; overflow: auto; max-height: 400px; border: 1px solid #eee; }
        table { border-collapse: separate; border-spacing: 0; width: 100%; white-space: nowrap; }
        thead th { position: sticky; top: 0; background: #f8f9fa !important; z-index: 20; border-bottom: 2px solid #ddd !important; }
        th:first-child, td:first-child { position: sticky; left: 0; z-index: 30; background-color: #f8f9fa !important; border-right: 2px solid #ddd !important; }
        thead th:first-child { z-index: 40; }
        .empty-cell { color: #ccc; text-align: center; }
        .rpm-val { color: #2980b9; font-weight: bold; }
        .count-val { font-weight: 500; }
        .cov-val { color: #27ae60; font-weight: 500; }
    </style>
</head>
<body>

<div class="top-navbar">
    <div class="row align-items-center">
        <div class="col-md-3">
            <h6 class="mb-0">NGS 分析報告對照工具 v2.1</h6>
        </div>
        <div class="col-md-3">
            <input type="file" id="fileInput" class="form-control form-control-sm" multiple accept=".txt,.md">
        </div>
        <div class="col-md-3">
            <input type="text" id="searchInput" class="form-control form-control-sm" placeholder="搜尋 Task ID 或 Note...">
        </div>
        <div class="col-md-3 text-end">
            <button onclick="exportAllToCSV()" class="btn btn-sm btn-success">匯出全數據 CSV</button>
        </div>
    </div>
</div>

<div class="main-wrapper">
    <div class="sidebar">
        <div class="sidebar-header">
            <div class="d-flex justify-content-between align-items-center mb-1">
                <h6>樣本管理</h6>
                <div class="btn-group">
                    <button class="btn btn-xs btn-outline-primary" style="font-size: 9px" onclick="toggleAllSamples(true)">全選</button>
                    <button class="btn btn-xs btn-outline-secondary" style="font-size: 9px" onclick="toggleAllSamples(false)">清除</button>
                </div>
            </div>
            <small class="text-muted" id="sampleCount">載入: 0</small>
        </div>
        <div class="sample-list" id="sampleSelector"></div>
    </div>

    <div class="content-area" id="tablesContainer">
        <div class="text-center text-muted mt-5">請選擇分析報告檔案 (.txt / .md)</div>
    </div>
</div>

<script>
let allData = [];
let selectedTaskIDs = new Set();
let dynamicKeys = { Host: new Set(), Impurity: new Set(), Reference: new Set(), BLAST: new Set() };

const CATEGORIES = [
    { id: 'meta', name: '分析基本資訊 (Meta)', keys: ['Task ID', 'Task Note', 'Finish Time', 'Preset ID', 'Preset Version', 'Viva Version'] },
    { id: 'qc', name: '讀序品質控制 (QC Statistics)', keys: ['Task ID', 'Total Reads(Before)', 'Total Reads(After)', 'Q30 Rate', 'Dup %', 'Mean length R1', 'Mean length R2'] },
    { id: 'host', name: '宿主過濾結果', keys: [] },
    { id: 'impurity_bwa', name: '外來病毒偵測 (BWA MEM)', keys: [] },
    { id: 'impurity_bt2', name: '外來病毒偵測 (Bowtie2)', keys: [] },
    { id: 'align_bwa', name: '參考序列覆蓋分析 (BWA MEM)', keys: [] },
    { id: 'align_bt2', name: '參考序列覆蓋分析 (Bowtie2)', keys: [] },
    { id: 'blast', name: '未比對 Contig 鑑定 (BLAST)', keys: [] }
];

document.getElementById('fileInput').addEventListener('change', handleFiles);
document.getElementById('searchInput').addEventListener('input', renderAll);

async function handleFiles(e) {
    const files = Array.from(e.target.files);
    if (files.length === 0) return;
    allData = [];
    selectedTaskIDs.clear();
    Object.keys(dynamicKeys).forEach(k => dynamicKeys[k].clear());
    for (const file of files) {
        const text = await file.text();
        const parsed = parseReport(text);
        allData.push(parsed);
        selectedTaskIDs.add(parsed["Task ID"]);
    }
    allData.sort((a, b) => a["Task ID"].localeCompare(b["Task ID"]));
    document.getElementById('sampleCount').innerText = `已載入: ${allData.length}`;
    renderSampleSelector();
    renderAll();
}

function parseReport(text) {
    const data = { "Task ID": "Unknown" };
    const lines = text.split('\n');

    // 1. Meta & Basic Info
    data["Task ID"] = text.match(/Task ID\s*:\s*(.+)/)?.[1] || text.match(/Task name\s*:\s*(.+)/)?.[1] || "N/A";
    data["Task Note"] = text.match(/Task note\s*:\s*(.+)/)?.[1] || "N/A";
    data["Finish Time"] = text.match(/Task finish time\s*:\s*(.+)/)?.[1] || "N/A";
    data["Preset ID"] = text.match(/Preset ID\s*:\s*(.+)/)?.[1] || "N/A";
    data["Preset Version"] = text.match(/Version\s*:\s*([\d\.]+)/)?.[1] || "N/A";
    data["Viva Version"] = text.match(/viva\s*\|\s*(v[\d\.]+)/)?.[1] || "N/A";

    // 2. QC
    const qcMatch = text.match(/Total reads\s*\|\s*(\d+)\s*\|\s*(\d+)\s*\|/);
    const rawReadsAfter = qcMatch ? parseInt(qcMatch[2]) : 1; // 基數不可為0
    if (qcMatch) {
        data["Total Reads(Before)"] = parseInt(qcMatch[1]).toLocaleString();
        data["Total Reads(After)"] = rawReadsAfter.toLocaleString();
    }
    const q30Match = text.match(/Q30 rate\s*\|\s*[\d\.]+\s*\|\s*([\d\.]+)\s*\|/);
    if (q30Match) data["Q30 Rate"] = (parseFloat(q30Match[1]) * 100).toFixed(2) + "%";
    data["Dup %"] = (text.match(/Duplication rate\s*:\s*([\d\.]+)%/)?.[1] || "0") + "%";
    
    const lenMatch = text.match(/Mean length R1\s*\|\s*(\d+)\s*\|\s*(\d+)\s*\|/);
    if (lenMatch) {
        data["Mean length R1"] = lenMatch[2];
        const lenR2Match = text.match(/Mean length R2\s*\|\s*(\d+)\s*\|\s*(\d+)\s*\|/);
        data["Mean length R2"] = lenR2Match ? lenR2Match[2] : "-";
    }

    // RPM Helper
    const calcRPM = (count) => ((count / rawReadsAfter) * 1000000).toFixed(4);

    // 3. Host
    const hostMatch = text.match(/Remove genome:\s*(.+)\n\nPercentage of removed reads:\s*([\d\.]+)%/);
    if (hostMatch) {
        const key = hostMatch[1].trim();
        data[`Host_${key}`] = hostMatch[2] + "%";
        dynamicKeys.Host.add(key);
    }

    // 4. Impurities (Dual aligners) - Modified for Cov%
    const impuritySections = text.split(/#### Impurities Prefilter #/);
    impuritySections.shift();
    impuritySections.forEach(sec => {
        const name = sec.trim().split('\n')[0].split(':')[1]?.trim() || "Unknown";
        dynamicKeys.Impurity.add(name);
        
        // BWA Logic
        const bwaMatch = sec.match(/\| BWA MEM \| [\d\.]+% \| (\d+) \|/);
        const bwaCov = sec.match(/\| BWA MEM \| [\d\.]+% \| \d+ \| ([\d\.]+)\s*% \|/); // Capture 4th col

        if (bwaMatch) {
            data[`Impurity_BWA_${name}_Count`] = bwaMatch[1];
            data[`Impurity_BWA_${name}_RPM`] = calcRPM(parseInt(bwaMatch[1]));
            data[`Impurity_BWA_${name}_Cov`] = bwaCov ? bwaCov[1] + "%" : "-";
        }

        // Bowtie2 Logic
        const bt2Match = sec.match(/\| Bowtie2 \| [\d\.]+% \| (\d+) \|/);
        const bt2Cov = sec.match(/\| Bowtie2 \| [\d\.]+% \| \d+ \| ([\d\.]+)\s*% \|/); // Capture 4th col

        if (bt2Match) {
            data[`Impurity_BT2_${name}_Count`] = bt2Match[1];
            data[`Impurity_BT2_${name}_RPM`] = calcRPM(parseInt(bt2Match[1]));
            data[`Impurity_BT2_${name}_Cov`] = bt2Cov ? bt2Cov[1] + "%" : "-";
        }
    });

    // 5. Alignment (Dual aligners)
    const coverageSections = text.split(/#### Reference #\d+ :/);
    coverageSections.shift();
    coverageSections.forEach(sec => {
        const refName = sec.split('\n')[0].trim();
        dynamicKeys.Reference.add(refName);

        const bwaMappedMatch = sec.match(/\| BWA MEM \| [\d\.]+% \| (\d+) \|/);
        const bt2MappedMatch = sec.match(/\| Bowtie2 \| [\d\.]+% \| (\d+) \|/);

        const bwaCovTable = sec.match(/\| BWA MEM \| \d+ \| \d+ \| ([\d\.]+) % \| ([\d\.]+) x \|/);
        const bt2CovTable = sec.match(/\| Bowtie2 \| \d+ \| \d+ \| ([\d\.]+) % \| ([\d\.]+) x \|/);

        if (bwaMappedMatch) {
            data[`Align_BWA_${refName}_RPM`] = calcRPM(parseInt(bwaMappedMatch[1]));
        }
        if (bt2MappedMatch) {
            data[`Align_BT2_${refName}_RPM`] = calcRPM(parseInt(bt2MappedMatch[1]));
        }

        if (bwaCovTable) {
            data[`Align_BWA_${refName}_Cov`] = bwaCovTable[1] + "%";
            data[`Align_BWA_${refName}_Dep`] = bwaCovTable[2] + "x";
        }
        if (bt2CovTable) {
            data[`Align_BT2_${refName}_Cov`] = bt2CovTable[1] + "%";
            data[`Align_BT2_${refName}_Dep`] = bt2CovTable[2] + "x";
        }
    });

    // 6. BLAST
    const blastSections = text.split(/### BLAST database: /);
    blastSections.shift();
    blastSections.forEach(sec => {
        const dbName = sec.split('\n')[0].trim();
        const rows = sec.match(/\| NODE_\d+ \|/g);
        data[`BLAST_${dbName}`] = rows ? rows.length : 0;
        dynamicKeys.BLAST.add(dbName);
    });

    return data;
}

function renderSampleSelector() {
    const container = document.getElementById('sampleSelector');
    container.innerHTML = allData.map(d => `
        <div class="sample-item">
            <input type="checkbox" checked onchange="toggleSample('${d["Task ID"]}')">
            <div class="sample-info"><strong>${d["Task ID"]}</strong><br>${d["Task Note"]}</div>
        </div>
    `).join('');
}

function toggleSample(id) {
    if (selectedTaskIDs.has(id)) selectedTaskIDs.delete(id);
    else selectedTaskIDs.add(id);
    renderAll();
}

function toggleAllSamples(checked) {
    selectedTaskIDs.clear();
    if (checked) allData.forEach(d => selectedTaskIDs.add(d["Task ID"]));
    document.querySelectorAll('#sampleSelector input').forEach(el => el.checked = checked);
    renderAll();
}

function renderAll() {
    const container = document.getElementById('tablesContainer');
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const displayData = allData.filter(d => {
    if (!selectedTaskIDs.has(d["Task ID"])) return false;
    if (!searchTerm) return true;
    return Object.values(d).some(value => 
        String(value).toLowerCase().includes(searchTerm)
    );
});

    if (displayData.length === 0) { container.innerHTML = '<div class="text-center p-5 text-muted">無顯示資料</div>'; return; }

    container.innerHTML = CATEGORIES.map(cat => {
        let cols = ["Task ID"];
        if (cat.id === 'meta' || cat.id === 'qc') cols = cat.keys;
        else if (cat.id === 'host') Array.from(dynamicKeys.Host).forEach(k => cols.push(`Host_${k}`));
        else if (cat.id === 'impurity_bwa') Array.from(dynamicKeys.Impurity).forEach(k => { 
            cols.push(`Impurity_BWA_${k}_Count`); 
            cols.push(`Impurity_BWA_${k}_RPM`);
            cols.push(`Impurity_BWA_${k}_Cov`); // Modified
        });
        else if (cat.id === 'impurity_bt2') Array.from(dynamicKeys.Impurity).forEach(k => { 
            cols.push(`Impurity_BT2_${k}_Count`); 
            cols.push(`Impurity_BT2_${k}_RPM`);
            cols.push(`Impurity_BT2_${k}_Cov`); // Modified
        });
        else if (cat.id === 'align_bwa') Array.from(dynamicKeys.Reference).forEach(k => { cols.push(`Align_BWA_${k}_Cov`); cols.push(`Align_BWA_${k}_Dep`); cols.push(`Align_BWA_${k}_RPM`); });
        else if (cat.id === 'align_bt2') Array.from(dynamicKeys.Reference).forEach(k => { cols.push(`Align_BT2_${k}_Cov`); cols.push(`Align_BT2_${k}_Dep`); cols.push(`Align_BT2_${k}_RPM`); });
        else if (cat.id === 'blast') Array.from(dynamicKeys.BLAST).forEach(k => cols.push(`BLAST_${k}`));

        if (cols.length <= 1 && cat.id !== 'meta' && cat.id !== 'qc') return '';

        return `
            <div class="section-card">
                <div class="table-title"><h6>${cat.name}</h6></div>
                <div class="table-container">
                    <table class="table table-sm table-bordered mb-0">
                        <thead><tr>${cols.map(c => `<th>${formatHeader(c)}</th>`).join('')}</tr></thead>
                        <tbody>${displayData.map(row => `<tr>${cols.map(c => {
                            const val = row[c] !== undefined ? row[c] : '<span class="empty-cell">-</span>';
                            let cls = '';
                            if (c.includes('RPM')) cls = 'rpm-val';
                            else if (c.includes('_Cov') || c.includes('_Rate')) cls = 'cov-val'; // Added color for Cov
                            else cls = 'count-val';
                            return `<td class="${cls}">${val}</td>`;
                        }).join('')}</tr>`).join('')}</tbody>
                    </table>
                </div>
            </div>
        `;
    }).join('');
}

function formatHeader(col) {
    if(col === "Task ID") return "Task ID";
    return col.replace(/Host_|Impurity_BWA_|Impurity_BT2_|Align_BWA_|Align_BT2_|BLAST_/g, '')
              .replace('_Count', ' (Reads)').replace('_RPM', ' (RPM)')
              .replace('_Cov', ' (Cov%)').replace('_Dep', ' (Depth)');
}

function exportAllToCSV() {
    let csv = "\uFEFF";
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const displayData = allData.filter(d => selectedTaskIDs.has(d["Task ID"]) && (d["Task ID"].toLowerCase().includes(searchTerm) || d["Task Note"].toLowerCase().includes(searchTerm)));

    CATEGORIES.forEach(cat => {
        let cols = ["Task ID"];
        if (cat.id === 'meta' || cat.id === 'qc') cols = cat.keys;
        else if (cat.id === 'host') Array.from(dynamicKeys.Host).forEach(k => cols.push(`Host_${k}`));
        else if (cat.id === 'impurity_bwa') Array.from(dynamicKeys.Impurity).forEach(k => { 
            cols.push(`Impurity_BWA_${k}_Count`); 
            cols.push(`Impurity_BWA_${k}_RPM`);
            cols.push(`Impurity_BWA_${k}_Cov`); 
        });
        else if (cat.id === 'impurity_bt2') Array.from(dynamicKeys.Impurity).forEach(k => { 
            cols.push(`Impurity_BT2_${k}_Count`); 
            cols.push(`Impurity_BT2_${k}_RPM`);
            cols.push(`Impurity_BT2_${k}_Cov`);
        });
        else if (cat.id === 'align_bwa') Array.from(dynamicKeys.Reference).forEach(k => { cols.push(`Align_BWA_${k}_Cov`); cols.push(`Align_BWA_${k}_Dep`); cols.push(`Align_BWA_${k}_RPM`); });
        else if (cat.id === 'align_bt2') Array.from(dynamicKeys.Reference).forEach(k => { cols.push(`Align_BT2_${k}_Cov`); cols.push(`Align_BT2_${k}_Dep`); cols.push(`Align_BT2_${k}_RPM`); });
        else if (cat.id === 'blast') Array.from(dynamicKeys.BLAST).forEach(k => cols.push(`BLAST_${k}`));

        if (cols.length > 1 || cat.id === 'meta') {
            csv += `${cat.name}\n`;
            csv += cols.map(c => `"${formatHeader(c)}"`).join(',') + "\n";
            displayData.forEach(row => {
                csv += cols.map(c => `"${(row[c] || '-')}"`).join(',') + "\n";
            });
            csv += "\n";
        }
    });
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = `NGS_Comprehensive_Report_${new Date().toISOString().slice(0,10)}.csv`;
    link.click();
}
</script>
</body>
</html>