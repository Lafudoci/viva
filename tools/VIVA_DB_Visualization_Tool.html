<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NGS 多樣本分析綜合報告對照工具 (DB版)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
    <style>
        :root {
            --sidebar-width: 320px;
        }

        body {
            background-color: #f0f2f5;
            font-size: 0.82rem;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .top-navbar {
            background: linear-gradient(135deg, #1a2537 0%, #2c3e50 100%);
            color: white;
            padding: 10px 20px;
            z-index: 1000;
            flex-shrink: 0;
        }

        .main-wrapper {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .sidebar {
            width: var(--sidebar-width);
            background: white;
            border-right: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .sidebar-header {
            padding: 15px;
            border-bottom: 1px solid #eee;
            background: #f8f9fa;
        }

        .sample-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .sample-item {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            padding: 8px;
            border-bottom: 1px solid #f0f0f0;
            border-radius: 4px;
            transition: background 0.15s;
        }

        .sample-item:hover {
            background: #f8f9fa;
        }

        .sample-info {
            font-size: 0.72rem;
            color: #666;
            word-break: break-all;
            flex: 1;
        }

        .sample-info strong {
            font-size: 0.78rem;
            color: #333;
        }

        .content-area {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .section-card {
            background: white;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 25px;
            padding: 15px;
        }

        .table-title {
            border-left: 4px solid #e67e22;
            padding-left: 10px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-container {
            position: relative;
            overflow: auto;
            max-height: 400px;
            border: 1px solid #eee;
        }

        table {
            border-collapse: separate;
            border-spacing: 0;
            width: 100%;
            white-space: nowrap;
        }

        thead th {
            position: sticky;
            top: 0;
            background: #f8f9fa !important;
            z-index: 20;
            border-bottom: 2px solid #ddd !important;
        }

        th:first-child,
        td:first-child {
            position: sticky;
            left: 0;
            z-index: 30;
            background-color: #f8f9fa !important;
            border-right: 2px solid #ddd !important;
        }

        thead th:first-child {
            z-index: 40;
        }

        .empty-cell {
            color: #ccc;
            text-align: center;
        }

        .rpm-val {
            color: #2980b9;
            font-weight: bold;
        }

        .count-val {
            font-weight: 500;
        }

        .cov-val {
            color: #27ae60;
            font-weight: 500;
        }

        /* Version badge styling */
        .version-badge {
            display: inline-block;
            background: #3498db;
            color: white;
            padding: 1px 6px;
            border-radius: 3px;
            font-size: 0.65rem;
            margin-left: 4px;
        }

        /* Duplicate run indicator */
        .run-count-badge {
            display: inline-block;
            background: #e67e22;
            color: white;
            padding: 1px 5px;
            border-radius: 3px;
            font-size: 0.62rem;
            cursor: pointer;
            margin-left: 4px;
        }

        .run-count-badge:hover {
            background: #d35400;
        }

        /* History popover */
        .history-popover {
            display: none;
            position: absolute;
            left: calc(var(--sidebar-width) + 10px);
            top: 0;
            z-index: 9999;
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
            padding: 12px;
            min-width: 360px;
            max-height: 300px;
            overflow-y: auto;
        }

        .history-popover.show {
            display: block;
        }

        .history-popover h6 {
            border-bottom: 1px solid #eee;
            padding-bottom: 6px;
            margin-bottom: 8px;
        }

        .history-item {
            padding: 4px 0;
            border-bottom: 1px solid #f5f5f5;
            font-size: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-item .badge-latest {
            background: #27ae60;
            color: white;
            padding: 1px 5px;
            border-radius: 3px;
            font-size: 0.6rem;
        }

        .history-item .badge-old {
            background: #95a5a6;
            color: white;
            padding: 1px 5px;
            border-radius: 3px;
            font-size: 0.6rem;
        }

        /* Loading overlay */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        .loading-overlay.show {
            display: flex;
        }

        .loading-spinner {
            background: white;
            padding: 30px 40px;
            border-radius: 8px;
            text-align: center;
        }

        .db-badge {
            background: #8e44ad;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
        }
    </style>
</head>

<body>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner">
            <div class="spinner-border text-primary mb-2" role="status"></div>
            <div>正在載入資料庫...</div>
        </div>
    </div>

    <div class="top-navbar">
        <div class="row align-items-center">
            <div class="col-md-3">
                <h6 class="mb-0">NGS 分析報告對照工具 <span class="db-badge">DB版</span></h6>
            </div>
            <div class="col-md-3">
                <input type="file" id="fileInput" class="form-control form-control-sm" accept=".db,.sqlite,.sqlite3">
            </div>
            <div class="col-md-3">
                <input type="text" id="searchInput" class="form-control form-control-sm"
                    placeholder="搜尋 Task Name 或 Note...">
            </div>
            <div class="col-md-3 text-end">
                <button onclick="exportAllToCSV()" class="btn btn-sm btn-success">匯出全數據 CSV</button>
            </div>
        </div>
    </div>

    <div class="main-wrapper">
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <h6>樣本管理 (依 Task Name 分群)</h6>
                    <div class="btn-group">
                        <button class="btn btn-xs btn-outline-primary" style="font-size: 9px"
                            onclick="toggleAllSamples(true)">全選</button>
                        <button class="btn btn-xs btn-outline-secondary" style="font-size: 9px"
                            onclick="toggleAllSamples(false)">清除</button>
                    </div>
                </div>
                <small class="text-muted" id="sampleCount">載入: 0 組 / 0 筆</small>
            </div>
            <div class="sample-list" id="sampleSelector"></div>
        </div>

        <div class="content-area" id="tablesContainer">
            <div class="text-center text-muted mt-5">請選擇資料庫檔案 (.db / .sqlite)</div>
        </div>
    </div>

    <!-- History popover (positioned dynamically) -->
    <div class="history-popover" id="historyPopover"></div>

    <script>
        // --- Global State ---
        let allGroups = [];         // Array of { groupName, latestData, runs: [{task_id, start_date, viva_version, ...}] }
        let allDataMap = {};        // task_id -> parsed data row (for CSV export convenience)
        let selectedGroups = new Set();

        const CATEGORIES = [
            { id: 'meta', name: '分析基本資訊 (Meta)', keys: ['Task Name', 'Task ID', 'Task Note', 'Finish Time', 'Preset ID', 'Preset Version', 'Viva Version', 'Runs'] },
            { id: 'qc', name: '讀序品質控制 (QC Statistics)', keys: ['Task Name', 'Total Reads(Before)', 'Total Reads(After)', 'Q30 Rate', 'Dup %', 'Mean length R1', 'Mean length R2'] },
            { id: 'host', name: '宿主過濾結果', keys: [] },
            { id: 'impurity_bwa', name: '外來病毒偵測 (BWA MEM)', keys: [] },
            { id: 'impurity_bt2', name: '外來病毒偵測 (Bowtie2)', keys: [] },
            { id: 'align_bwa', name: '參考序列覆蓋分析 (BWA MEM)', keys: [] },
            { id: 'align_bt2', name: '參考序列覆蓋分析 (Bowtie2)', keys: [] },
            { id: 'blast', name: '未比對 Contig 鑑定 (BLAST)', keys: [] }
        ];

        document.getElementById('fileInput').addEventListener('change', handleFile);
        document.getElementById('searchInput').addEventListener('input', renderAll);

        // Close history popover when clicking elsewhere
        document.addEventListener('click', function (e) {
            if (!e.target.closest('.run-count-badge') && !e.target.closest('#historyPopover')) {
                document.getElementById('historyPopover').classList.remove('show');
            }
        });

        // --- Main entry: load .db file ---
        async function handleFile(e) {
            const file = e.target.files[0];
            if (!file) return;

            const overlay = document.getElementById('loadingOverlay');
            overlay.classList.add('show');

            try {
                const SQL = await initSqlJs({
                    locateFile: f => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${f}`
                });

                const buf = await file.arrayBuffer();
                const db = new SQL.Database(new Uint8Array(buf));

                parseDatabase(db);
                db.close();

                document.getElementById('sampleCount').innerText = `已載入: ${allGroups.length} 組 / ${Object.keys(allDataMap).length} 筆`;
                renderSampleSelector();
                renderAll();
            } catch (err) {
                alert('讀取資料庫失敗: ' + err.message);
                console.error(err);
            } finally {
                overlay.classList.remove('show');
            }
        }

        // --- Parse SQLite database into structured data ---
        function parseDatabase(db) {
            allGroups = [];
            allDataMap = {};
            selectedGroups.clear();

            // 1. Get all completed tasks
            const tasks = queryAll(db, `
        SELECT task_id, task_name, start_date, finish_date, status,
               preset_id, task_note, product_name, product_lot, seq_date,
               viva_version, preset_version
        FROM Tasks
        WHERE status = 'Completed'
        ORDER BY start_date DESC
    `);

            if (tasks.length === 0) {
                alert('資料庫中沒有已完成的任務。');
                return;
            }

            // 2. Get QC data
            const qcRows = queryAll(db, `SELECT * FROM QC_Metrics`);
            const qcMap = {};
            qcRows.forEach(r => { qcMap[r.task_id] = r; });

            // 3. Get Alignment Stats
            const alnRows = queryAll(db, `SELECT * FROM Alignment_Stats`);
            const alnMap = {};  // task_id -> [{...}]
            alnRows.forEach(r => {
                if (!alnMap[r.task_id]) alnMap[r.task_id] = [];
                alnMap[r.task_id].push(r);
            });

            // 4. Get Impurities Stats
            const impRows = queryAll(db, `SELECT * FROM Impurities_Stats`);
            const impMap = {};
            impRows.forEach(r => {
                if (!impMap[r.task_id]) impMap[r.task_id] = [];
                impMap[r.task_id].push(r);
            });

            // 5. Get BLAST Results
            const blastRows = queryAll(db, `SELECT * FROM BLAST_Results`);
            const blastMap = {};
            blastRows.forEach(r => {
                if (!blastMap[r.task_id]) blastMap[r.task_id] = [];
                blastMap[r.task_id].push(r);
            });

            // 6. Derive group name (task prefix) from task_id by stripping trailing _YYYYMMDDHHMM timestamp
            function deriveTaskPrefix(taskId) {
                // task_id format: {task_name}_{YYYYMMDDHHMM} (12-digit timestamp after last underscore)
                const match = taskId.match(/^(.+)_(\d{12})$/);
                if (match) return match[1];
                return taskId; // fallback: use full task_id if no timestamp found
            }

            // Group tasks by derived prefix
            const groupMap = {};  // prefix -> [task rows]
            tasks.forEach(t => {
                const groupKey = deriveTaskPrefix(t.task_id);
                if (!groupMap[groupKey]) groupMap[groupKey] = [];
                groupMap[groupKey].push(t);
            });

            // 7. Sort each group by start_date DESC, then build allGroups
            for (const [groupName, taskList] of Object.entries(groupMap)) {
                taskList.sort((a, b) => (b.start_date || '').localeCompare(a.start_date || ''));
                const latestTask = taskList[0];
                const latestTaskId = latestTask.task_id;
                const data = buildDataRow(latestTask, qcMap[latestTaskId], alnMap[latestTaskId], impMap[latestTaskId], blastMap[latestTaskId]);

                // Override Task Name with the derived prefix
                data['Task Name'] = groupName;

                // Add run count
                data['Runs'] = taskList.length;

                const runs = taskList.map(t => ({
                    task_id: t.task_id,
                    start_date: t.start_date,
                    finish_date: t.finish_date,
                    viva_version: t.viva_version || 'N/A',
                    preset_version: t.preset_version || 'N/A',
                    isLatest: t.task_id === latestTaskId
                }));

                allGroups.push({ groupName, latestData: data, runs });
                allDataMap[latestTaskId] = data;
                selectedGroups.add(groupName);
            }

            // Sort groups alphabetically
            allGroups.sort((a, b) => a.groupName.localeCompare(b.groupName));
        }

        // --- Build a single data row from DB query results ---
        function buildDataRow(task, qc, alnArr, impArr, blastArr) {
            const data = {};

            // Meta
            data['Task Name'] = task.task_name || task.task_id;
            data['Task ID'] = task.task_id;
            data['Task Note'] = task.task_note || 'N/A';
            data['Finish Time'] = task.finish_date || 'N/A';
            data['Preset ID'] = task.preset_id || 'N/A';
            data['Preset Version'] = task.preset_version || 'N/A';
            data['Viva Version'] = task.viva_version || 'N/A';

            // QC
            const rawReadsAfter = qc ? (qc.fastp_after_reads || 1) : 1;
            if (qc) {
                data['Total Reads(Before)'] = qc.fastp_before_reads ? parseInt(qc.fastp_before_reads).toLocaleString() : 'N/A';
                data['Total Reads(After)'] = qc.fastp_after_reads ? parseInt(qc.fastp_after_reads).toLocaleString() : 'N/A';
                data['Q30 Rate'] = qc.fastp_after_q30 != null ? (parseFloat(qc.fastp_after_q30) * 100).toFixed(2) + '%' : 'N/A';
                data['Dup %'] = qc.duplication_rate != null ? (parseFloat(qc.duplication_rate) * 100).toFixed(2) + '%' : 'N/A';
                data['Mean length R1'] = qc.mean_length_r1 || '-';
                data['Mean length R2'] = qc.mean_length_r2 || '-';

                // Host
                if (qc.remove_host_name) {
                    const hostKey = qc.remove_host_name;
                    data[`Host_${hostKey}`] = qc.remove_host_pct != null ? parseFloat(qc.remove_host_pct).toFixed(2) + '%' : 'N/A';
                }
            }

            // RPM helper
            const calcRPM = (count) => ((count / rawReadsAfter) * 1000000).toFixed(4);

            // Impurities
            if (impArr) {
                impArr.forEach(imp => {
                    const name = imp.impurity_name;
                    const alignerPrefix = imp.aligner === 'bowtie2' ? 'BT2' : 'BWA';

                    data[`Impurity_${alignerPrefix}_${name}_Count`] = imp.mapped_reads;
                    data[`Impurity_${alignerPrefix}_${name}_RPM`] = calcRPM(parseInt(imp.mapped_reads));
                    data[`Impurity_${alignerPrefix}_${name}_Cov`] = imp.coverage != null ? parseFloat(imp.coverage).toFixed(2) + '%' : '-';
                });
            }

            // Alignment
            if (alnArr) {
                alnArr.forEach(aln => {
                    const refName = aln.ref_header;
                    const alignerPrefix = aln.aligner === 'bowtie2' ? 'BT2' : 'BWA';

                    data[`Align_${alignerPrefix}_${refName}_RPM`] = calcRPM(parseInt(aln.mapped_reads));
                    data[`Align_${alignerPrefix}_${refName}_Cov`] = aln.coverage != null ? parseFloat(aln.coverage).toFixed(2) + '%' : '-';
                    data[`Align_${alignerPrefix}_${refName}_Dep`] = aln.mean_depth != null ? parseFloat(aln.mean_depth).toFixed(2) + 'x' : '-';
                });
            }

            // BLAST
            if (blastArr) {
                blastArr.forEach(b => {
                    data[`BLAST_${b.db_name}`] = b.hit_count;
                });
            }

            return data;
        }

        // --- Helper: run SQL query and return array of objects ---
        function queryAll(db, sql) {
            const results = [];
            try {
                const stmt = db.prepare(sql);
                while (stmt.step()) {
                    const row = stmt.getAsObject();
                    results.push(row);
                }
                stmt.free();
            } catch (e) {
                console.warn('Query error:', e.message, sql);
            }
            return results;
        }

        // --- Render sidebar ---
        function renderSampleSelector() {
            const container = document.getElementById('sampleSelector');
            container.innerHTML = allGroups.map(g => {
                const d = g.latestData;
                const runsBadge = g.runs.length > 1
                    ? `<span class="run-count-badge" onclick="showHistory(event, '${escapeHtml(g.groupName)}')" title="點擊查看歷史紀錄">${g.runs.length} 次</span>`
                    : '';
                const versionBadge = d['Viva Version'] !== 'N/A'
                    ? `<span class="version-badge">${d['Viva Version']}</span>`
                    : '';
                return `
            <div class="sample-item">
                <input type="checkbox" checked onchange="toggleSample('${escapeHtml(g.groupName)}')">
                <div class="sample-info">
                    <strong>${escapeHtml(g.groupName)}</strong>${versionBadge}${runsBadge}<br>
                    <span style="color:#888">${escapeHtml(d['Task Note'])}</span><br>
                    <span style="color:#aaa; font-size:0.65rem">最新: ${escapeHtml(d['Task ID'])}</span>
                </div>
            </div>
        `;
            }).join('');
        }

        // --- Show history popover for a group ---
        function showHistory(event, groupName) {
            event.stopPropagation();
            const popover = document.getElementById('historyPopover');
            const group = allGroups.find(g => g.groupName === groupName);
            if (!group) return;

            const rect = event.target.getBoundingClientRect();
            popover.style.top = (rect.top + window.scrollY) + 'px';
            popover.style.left = (rect.right + 10) + 'px';
            popover.style.position = 'fixed';

            popover.innerHTML = `
        <h6>「${escapeHtml(groupName)}」分析歷史 (${group.runs.length} 次)</h6>
        ${group.runs.map(r => `
            <div class="history-item">
                <div>
                    <span class="${r.isLatest ? 'badge-latest' : 'badge-old'}">${r.isLatest ? '最新' : '舊版'}</span>
                    <strong>${escapeHtml(r.task_id)}</strong>
                </div>
                <div style="text-align:right; font-size:0.68rem; color:#888;">
                    VIVA ${r.viva_version} | ${r.start_date || 'N/A'}
                </div>
            </div>
        `).join('')}
    `;
            popover.classList.add('show');
        }

        function toggleSample(groupName) {
            if (selectedGroups.has(groupName)) selectedGroups.delete(groupName);
            else selectedGroups.add(groupName);
            renderAll();
        }

        function toggleAllSamples(checked) {
            selectedGroups.clear();
            if (checked) allGroups.forEach(g => selectedGroups.add(g.groupName));
            document.querySelectorAll('#sampleSelector input[type=checkbox]').forEach(el => el.checked = checked);
            renderAll();
        }

        // --- Compute dynamic keys from a given set of data rows ---
        function computeDynamicKeys(dataRows) {
            const dk = { Host: new Set(), Impurity: new Set(), Reference: new Set(), BLAST: new Set() };
            dataRows.forEach(row => {
                Object.keys(row).forEach(key => {
                    let m;
                    if ((m = key.match(/^Host_(.+)$/))) dk.Host.add(m[1]);
                    else if ((m = key.match(/^Impurity_(?:BWA|BT2)_(.+?)_(?:Count|RPM|Cov)$/))) dk.Impurity.add(m[1]);
                    else if ((m = key.match(/^Align_(?:BWA|BT2)_(.+?)_(?:RPM|Cov|Dep)$/))) dk.Reference.add(m[1]);
                    else if ((m = key.match(/^BLAST_(.+)$/))) dk.BLAST.add(m[1]);
                });
            });
            return dk;
        }

        // --- Main render ---
        function renderAll() {
            const container = document.getElementById('tablesContainer');
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();

            const displayData = allGroups.filter(g => {
                if (!selectedGroups.has(g.groupName)) return false;
                if (!searchTerm) return true;
                const d = g.latestData;
                return Object.values(d).some(value =>
                    String(value).toLowerCase().includes(searchTerm)
                );
            }).map(g => g.latestData);

            if (displayData.length === 0) {
                container.innerHTML = '<div class="text-center p-5 text-muted">無顯示資料</div>';
                return;
            }

            // Recompute dynamic keys based on currently displayed data only
            const activeDK = computeDynamicKeys(displayData);

            container.innerHTML = CATEGORIES.map(cat => {
                let cols = ['Task Name'];
                if (cat.id === 'meta' || cat.id === 'qc') cols = cat.keys;
                else if (cat.id === 'host') Array.from(activeDK.Host).forEach(k => cols.push(`Host_${k}`));
                else if (cat.id === 'impurity_bwa') Array.from(activeDK.Impurity).forEach(k => {
                    cols.push(`Impurity_BWA_${k}_Count`);
                    cols.push(`Impurity_BWA_${k}_RPM`);
                    cols.push(`Impurity_BWA_${k}_Cov`);
                });
                else if (cat.id === 'impurity_bt2') Array.from(activeDK.Impurity).forEach(k => {
                    cols.push(`Impurity_BT2_${k}_Count`);
                    cols.push(`Impurity_BT2_${k}_RPM`);
                    cols.push(`Impurity_BT2_${k}_Cov`);
                });
                else if (cat.id === 'align_bwa') Array.from(activeDK.Reference).forEach(k => {
                    cols.push(`Align_BWA_${k}_Cov`);
                    cols.push(`Align_BWA_${k}_Dep`);
                    cols.push(`Align_BWA_${k}_RPM`);
                });
                else if (cat.id === 'align_bt2') Array.from(activeDK.Reference).forEach(k => {
                    cols.push(`Align_BT2_${k}_Cov`);
                    cols.push(`Align_BT2_${k}_Dep`);
                    cols.push(`Align_BT2_${k}_RPM`);
                });
                else if (cat.id === 'blast') Array.from(activeDK.BLAST).forEach(k => cols.push(`BLAST_${k}`));

                if (cols.length <= 1 && cat.id !== 'meta' && cat.id !== 'qc') return '';

                return `
            <div class="section-card">
                <div class="table-title"><h6>${cat.name}</h6></div>
                <div class="table-container">
                    <table class="table table-sm table-bordered mb-0">
                        <thead><tr>${cols.map(c => `<th>${formatHeader(c)}</th>`).join('')}</tr></thead>
                        <tbody>${displayData.map(row => `<tr>${cols.map(c => {
                    const val = row[c] !== undefined ? row[c] : '<span class="empty-cell">-</span>';
                    let cls = '';
                    if (c.includes('RPM')) cls = 'rpm-val';
                    else if (c.includes('_Cov') || c.includes('_Rate') || c === 'Q30 Rate') cls = 'cov-val';
                    else cls = 'count-val';
                    return `<td class="${cls}">${val}</td>`;
                }).join('')}</tr>`).join('')}</tbody>
                    </table>
                </div>
            </div>
        `;
            }).join('');
        }

        function formatHeader(col) {
            if (col === 'Task Name' || col === 'Task ID') return col;
            return col.replace(/Host_|Impurity_BWA_|Impurity_BT2_|Align_BWA_|Align_BT2_|BLAST_/g, '')
                .replace('_Count', ' (Reads)').replace('_RPM', ' (RPM)')
                .replace('_Cov', ' (Cov%)').replace('_Dep', ' (Depth)');
        }

        function escapeHtml(str) {
            if (!str) return '';
            return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }

        // --- CSV Export ---
        function exportAllToCSV() {
            let csv = "\uFEFF"; // BOM for Excel
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const displayData = allGroups.filter(g => {
                if (!selectedGroups.has(g.groupName)) return false;
                if (!searchTerm) return true;
                return Object.values(g.latestData).some(v => String(v).toLowerCase().includes(searchTerm));
            }).map(g => g.latestData);

            // Recompute dynamic keys for CSV based on displayed data
            const csvDK = computeDynamicKeys(displayData);

            CATEGORIES.forEach(cat => {
                let cols = ['Task Name'];
                if (cat.id === 'meta' || cat.id === 'qc') cols = cat.keys;
                else if (cat.id === 'host') Array.from(csvDK.Host).forEach(k => cols.push(`Host_${k}`));
                else if (cat.id === 'impurity_bwa') Array.from(csvDK.Impurity).forEach(k => {
                    cols.push(`Impurity_BWA_${k}_Count`);
                    cols.push(`Impurity_BWA_${k}_RPM`);
                    cols.push(`Impurity_BWA_${k}_Cov`);
                });
                else if (cat.id === 'impurity_bt2') Array.from(csvDK.Impurity).forEach(k => {
                    cols.push(`Impurity_BT2_${k}_Count`);
                    cols.push(`Impurity_BT2_${k}_RPM`);
                    cols.push(`Impurity_BT2_${k}_Cov`);
                });
                else if (cat.id === 'align_bwa') Array.from(csvDK.Reference).forEach(k => {
                    cols.push(`Align_BWA_${k}_Cov`); cols.push(`Align_BWA_${k}_Dep`); cols.push(`Align_BWA_${k}_RPM`);
                });
                else if (cat.id === 'align_bt2') Array.from(csvDK.Reference).forEach(k => {
                    cols.push(`Align_BT2_${k}_Cov`); cols.push(`Align_BT2_${k}_Dep`); cols.push(`Align_BT2_${k}_RPM`);
                });
                else if (cat.id === 'blast') Array.from(csvDK.BLAST).forEach(k => cols.push(`BLAST_${k}`));

                if (cols.length > 1 || cat.id === 'meta') {
                    csv += `${cat.name}\n`;
                    csv += cols.map(c => `"${formatHeader(c)}"`).join(',') + "\n";
                    displayData.forEach(row => {
                        csv += cols.map(c => `"${(row[c] || '-')}"`).join(',') + "\n";
                    });
                    csv += "\n";
                }
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `NGS_DB_Report_${new Date().toISOString().slice(0, 10)}.csv`;
            link.click();
        }
    </script>
</body>

</html>