<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NGS å¤šæ¨£æœ¬åˆ†æç¶œåˆå ±å‘Šå°ç…§å·¥å…· (DBç‰ˆ)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
    <style>
        :root {
            --sidebar-width: 380px;
        }

        body {
            background-color: #f0f2f5;
            font-size: 0.82rem;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .top-navbar {
            background: linear-gradient(135deg, #1a2537 0%, #2c3e50 100%);
            color: white;
            padding: 10px 20px;
            z-index: 1000;
            flex-shrink: 0;
        }

        .main-wrapper {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .sidebar {
            width: var(--sidebar-width);
            min-width: 200px;
            max-width: 600px;
            background: white;
            border-right: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        /* Resize handle */
        .sidebar-resizer {
            width: 5px;
            cursor: col-resize;
            background: transparent;
            flex-shrink: 0;
            transition: background 0.2s;
            position: relative;
            z-index: 100;
        }

        .sidebar-resizer:hover,
        .sidebar-resizer.active {
            background: #3498db;
        }

        .sidebar-header {
            padding: 12px;
            border-bottom: 1px solid #eee;
            background: #f8f9fa;
        }

        /* Filter panel */
        .filter-panel {
            border-bottom: 1px solid #eee;
            background: #fafbfc;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease;
        }

        .filter-panel.open {
            max-height: 600px;
            padding: 10px 12px;
            overflow-y: auto;
        }

        .filter-toggle-btn {
            font-size: 0.72rem;
            padding: 2px 8px;
            border-radius: 3px;
            cursor: pointer;
            border: 1px solid #3498db;
            background: white;
            color: #3498db;
            transition: all 0.15s;
        }

        .filter-toggle-btn:hover,
        .filter-toggle-btn.active {
            background: #3498db;
            color: white;
        }

        .filter-rule {
            display: flex;
            align-items: center;
            gap: 4px;
            margin-bottom: 6px;
            flex-wrap: nowrap;
        }

        .filter-rule select {
            font-size: 0.72rem;
            padding: 2px 4px;
            border: 1px solid #ccc;
            border-radius: 3px;
            background: white;
        }

        .filter-rule input[type="text"] {
            flex: 1;
            font-size: 0.72rem;
            padding: 2px 6px;
            border: 1px solid #ccc;
            border-radius: 3px;
            min-width: 60px;
        }

        .filter-rule .remove-rule-btn {
            background: none;
            border: none;
            color: #e74c3c;
            cursor: pointer;
            font-size: 0.85rem;
            padding: 0 4px;
            line-height: 1;
        }

        .filter-rule .remove-rule-btn:hover {
            color: #c0392b;
        }

        .filter-section-label {
            font-size: 0.7rem;
            color: #666;
            font-weight: 600;
            margin-bottom: 4px;
            margin-top: 6px;
        }

        .filter-actions {
            display: flex;
            gap: 6px;
            margin-top: 8px;
        }

        .filter-actions button {
            font-size: 0.7rem;
            padding: 3px 10px;
            border-radius: 3px;
            cursor: pointer;
        }

        .filter-logic-toggle {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 0.7rem;
            margin-bottom: 6px;
        }

        .filter-logic-toggle label {
            cursor: pointer;
            padding: 1px 6px;
            border-radius: 3px;
            border: 1px solid #ccc;
            transition: all 0.15s;
        }

        .filter-logic-toggle input[type="radio"] {
            display: none;
        }

        .filter-logic-toggle input[type="radio"]:checked+label {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }

        .version-filter-row {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .version-filter-row select,
        .version-filter-row input {
            font-size: 0.72rem;
            padding: 2px 4px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }

        .version-filter-row input {
            width: 70px;
        }

        .sample-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .sample-item {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            padding: 8px;
            border-bottom: 1px solid #f0f0f0;
            border-radius: 4px;
            transition: background 0.15s;
        }

        .sample-item:hover {
            background: #f8f9fa;
        }

        .sample-item.filtered-out {
            display: none;
        }

        .sample-info {
            font-size: 0.72rem;
            color: #666;
            word-break: break-all;
            flex: 1;
        }

        .sample-info strong {
            font-size: 0.78rem;
            color: #333;
        }

        .content-area {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .section-card {
            background: white;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 25px;
            padding: 15px;
        }

        .table-title {
            border-left: 4px solid #e67e22;
            padding-left: 10px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-container {
            position: relative;
            overflow: auto;
            max-height: 400px;
            border: 1px solid #eee;
        }

        table {
            border-collapse: separate;
            border-spacing: 0;
            width: 100%;
            white-space: nowrap;
        }

        thead th {
            position: sticky;
            top: 0;
            background: #f8f9fa !important;
            z-index: 20;
            border-bottom: 2px solid #ddd !important;
        }

        th:first-child,
        td:first-child {
            position: sticky;
            left: 0;
            z-index: 30;
            background-color: #f8f9fa !important;
            border-right: 2px solid #ddd !important;
        }

        thead th:first-child {
            z-index: 40;
        }

        .empty-cell {
            color: #ccc;
            text-align: center;
        }

        .rpm-val {
            color: #2980b9;
            font-weight: bold;
        }

        .count-val {
            font-weight: 500;
        }

        .cov-val {
            color: #27ae60;
            font-weight: 500;
        }

        /* Version badge styling */
        .version-badge {
            display: inline-block;
            background: #3498db;
            color: white;
            padding: 1px 6px;
            border-radius: 3px;
            font-size: 0.65rem;
            margin-left: 4px;
        }

        /* Duplicate run indicator */
        .run-count-badge {
            display: inline-block;
            background: #e67e22;
            color: white;
            padding: 1px 5px;
            border-radius: 3px;
            font-size: 0.62rem;
            cursor: pointer;
            margin-left: 4px;
        }

        .run-count-badge:hover {
            background: #d35400;
        }

        /* History popover */
        .history-popover {
            display: none;
            position: absolute;
            left: calc(var(--sidebar-width) + 10px);
            top: 0;
            z-index: 9999;
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
            padding: 12px;
            min-width: 400px;
            max-height: 350px;
            overflow-y: auto;
        }

        .history-popover.show {
            display: block;
        }

        .history-popover h6 {
            border-bottom: 1px solid #eee;
            padding-bottom: 6px;
            margin-bottom: 8px;
        }

        .history-item {
            padding: 6px 8px;
            border-bottom: 1px solid #f5f5f5;
            font-size: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            border-radius: 4px;
            transition: background 0.15s;
        }

        .history-item:hover {
            background: #eaf2ff;
        }

        .history-item.selected {
            background: #d4edff;
            border: 1px solid #3498db;
        }

        .history-item .badge-latest {
            background: #27ae60;
            color: white;
            padding: 1px 5px;
            border-radius: 3px;
            font-size: 0.6rem;
        }

        .history-item .badge-old {
            background: #95a5a6;
            color: white;
            padding: 1px 5px;
            border-radius: 3px;
            font-size: 0.6rem;
        }

        .history-item .badge-selected {
            background: #3498db;
            color: white;
            padding: 1px 5px;
            border-radius: 3px;
            font-size: 0.6rem;
        }

        /* Loading overlay */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        .loading-overlay.show {
            display: flex;
        }

        .loading-spinner {
            background: white;
            padding: 30px 40px;
            border-radius: 8px;
            text-align: center;
        }

        .db-badge {
            background: #8e44ad;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
        }

        /* Prevent text selection during resize */
        body.resizing {
            user-select: none;
            cursor: col-resize;
        }

        .filter-active-count {
            display: inline-block;
            background: #e74c3c;
            color: white;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            text-align: center;
            line-height: 16px;
            font-size: 0.6rem;
            margin-left: 4px;
        }

        /* DB info bar */
        .db-info-bar {
            display: none;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: #ddd;
            padding: 5px 20px;
            font-size: 0.72rem;
            flex-shrink: 0;
            gap: 16px;
            align-items: center;
            flex-wrap: wrap;
        }

        .db-info-bar.show {
            display: flex;
        }

        .db-info-bar .info-item {
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .db-info-bar .info-label {
            color: #95a5a6;
        }

        .db-info-bar .info-value {
            color: #ecf0f1;
            font-weight: 600;
        }
    </style>
</head>

<body>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner">
            <div class="spinner-border text-primary mb-2" role="status"></div>
            <div>æ­£åœ¨è¼‰å…¥è³‡æ–™åº«...</div>
        </div>
    </div>

    <div class="top-navbar">
        <div class="row align-items-center">
            <div class="col-md-4">
                <h6 class="mb-0">NGS åˆ†æå ±å‘Šå°ç…§å·¥å…· <span class="db-badge">DBç‰ˆ</span></h6>
            </div>
            <div class="col-md-4">
                <input type="file" id="fileInput" class="form-control form-control-sm" accept=".db,.sqlite,.sqlite3">
            </div>
            <div class="col-md-4 text-end">
                <button onclick="exportAllToCSV()" class="btn btn-sm btn-success">åŒ¯å‡ºå…¨æ•¸æ“š CSV</button>
            </div>
        </div>
    </div>

    <div class="db-info-bar" id="dbInfoBar"></div>

    <div class="main-wrapper">
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <h6 class="mb-0">æ¨£æœ¬ç®¡ç†</h6>
                    <div class="d-flex gap-1 align-items-center">
                        <button class="filter-toggle-btn" id="filterToggleBtn" onclick="toggleFilterPanel()">âš™
                            ç¯©é¸</button>
                        <button class="btn btn-xs btn-outline-primary" style="font-size: 9px"
                            onclick="toggleAllSamples(true)">å…¨é¸</button>
                        <button class="btn btn-xs btn-outline-secondary" style="font-size: 9px"
                            onclick="toggleAllSamples(false)">æ¸…é™¤</button>
                    </div>
                </div>
                <small class="text-muted" id="sampleCount">è¼‰å…¥: 0 çµ„ / 0 ç­†</small>
            </div>

            <!-- Advanced Filter Panel -->
            <div class="filter-panel" id="filterPanel">
                <div class="filter-section-label">é—œéµå­—ç¯©é¸è¦å‰‡</div>
                <div class="filter-logic-toggle">
                    <span>å¤šæ¢åŒ…å«è¦å‰‡ä¹‹é–“:</span>
                    <input type="radio" name="filterLogic" id="logicOr" value="or" checked>
                    <label for="logicOr">è¯é›† (OR)</label>
                    <input type="radio" name="filterLogic" id="logicAnd" value="and">
                    <label for="logicAnd">äº¤é›† (AND)</label>
                </div>
                <div id="filterRulesContainer"></div>
                <button class="btn btn-sm btn-outline-secondary" style="font-size:0.68rem; padding:1px 8px;"
                    onclick="addFilterRule()">+ æ–°å¢æ¢ä»¶</button>

                <div class="filter-section-label">VIVA ç‰ˆæœ¬ç¯©é¸</div>
                <div class="version-filter-row">
                    <select id="versionOp">
                        <option value="">ä¸ç¯©é¸</option>
                        <option value="eq">=</option>
                        <option value="gte">â‰¥</option>
                        <option value="gt">></option>
                        <option value="lte">â‰¤</option>
                        <option value="lt">
                            << /option>
                    </select>
                    <input type="text" id="versionValue" placeholder="ä¾‹: 1.12">
                </div>

                <div class="filter-actions">
                    <button class="btn btn-primary btn-sm" onclick="applyFilters()">å¥—ç”¨ç¯©é¸</button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="clearFilters()">æ¸…é™¤å…¨éƒ¨</button>
                </div>
            </div>

            <div class="sample-list" id="sampleSelector"></div>
        </div>

        <!-- Resize Handle -->
        <div class="sidebar-resizer" id="sidebarResizer"></div>

        <div class="content-area" id="tablesContainer">
            <div class="text-center text-muted mt-5">è«‹é¸æ“‡è³‡æ–™åº«æª”æ¡ˆ (.db / .sqlite)</div>
        </div>
    </div>

    <!-- History popover (positioned dynamically) -->
    <div class="history-popover" id="historyPopover"></div>

    <script>
        // --- Global State ---
        let allGroups = [];         // Array of { groupName, latestData, activeData, activeTaskId, runs: [{task_id, start_date, viva_version, ...}] }
        let allRunDataMap = {};     // task_id -> parsed data row (for ALL runs, not just latest)
        let selectedGroups = new Set();
        let filteredGroups = null;  // null = no filter active; Set of groupNames when active
        let dbInstance = null;      // Keep reference for history switching

        // Filter state
        let filterRules = [];       // [{field, mode, value}]
        let filterRuleIdCounter = 0;

        const CATEGORIES = [
            { id: 'meta', name: 'åˆ†æåŸºæœ¬è³‡è¨Š (Meta)', keys: ['Task Name', 'Task ID', 'Task Note', 'Finish Time', 'Preset ID', 'Preset Version', 'Viva Version', 'Runs'] },
            { id: 'qc', name: 'è®€åºå“è³ªæ§åˆ¶ (QC Statistics)', keys: ['Task Name', 'Total Reads(Before)', 'Total Reads(After)', 'Q30 Rate', 'Dup %', 'Mean length R1', 'Mean length R2'] },
            { id: 'host', name: 'å®¿ä¸»éæ¿¾çµæœ', keys: [] },
            { id: 'impurity_bwa', name: 'å¤–ä¾†ç—…æ¯’åµæ¸¬ (BWA MEM)', keys: [] },
            { id: 'impurity_bt2', name: 'å¤–ä¾†ç—…æ¯’åµæ¸¬ (Bowtie2)', keys: [] },
            { id: 'align_bwa', name: 'åƒè€ƒåºåˆ—è¦†è“‹åˆ†æ (BWA MEM)', keys: [] },
            { id: 'align_bt2', name: 'åƒè€ƒåºåˆ—è¦†è“‹åˆ†æ (Bowtie2)', keys: [] },
            { id: 'blast', name: 'æœªæ¯”å° Contig é‘‘å®š (BLAST)', keys: [] }
        ];

        document.getElementById('fileInput').addEventListener('change', handleFile);

        // Close history popover when clicking elsewhere
        document.addEventListener('click', function (e) {
            if (!e.target.closest('.run-count-badge') && !e.target.closest('#historyPopover')) {
                document.getElementById('historyPopover').classList.remove('show');
            }
        });

        // ==========================================
        // Sidebar Resizer
        // ==========================================
        (function initResizer() {
            const resizer = document.getElementById('sidebarResizer');
            const sidebar = document.getElementById('sidebar');
            let startX, startWidth;

            resizer.addEventListener('mousedown', function (e) {
                e.preventDefault();
                startX = e.clientX;
                startWidth = sidebar.getBoundingClientRect().width;
                resizer.classList.add('active');
                document.body.classList.add('resizing');

                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            });

            function onMouseMove(e) {
                let newWidth = startWidth + (e.clientX - startX);
                newWidth = Math.max(200, Math.min(600, newWidth));
                document.documentElement.style.setProperty('--sidebar-width', newWidth + 'px');
                sidebar.style.width = newWidth + 'px';
            }

            function onMouseUp() {
                resizer.classList.remove('active');
                document.body.classList.remove('resizing');
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
            }
        })();

        // ==========================================
        // Filter Panel
        // ==========================================
        function toggleFilterPanel() {
            const panel = document.getElementById('filterPanel');
            const btn = document.getElementById('filterToggleBtn');
            panel.classList.toggle('open');
            btn.classList.toggle('active');
            // Add initial rule if empty
            if (panel.classList.contains('open') && filterRules.length === 0) {
                addFilterRule();
            }
        }

        function addFilterRule() {
            const id = ++filterRuleIdCounter;
            filterRules.push({ id, field: 'all', mode: 'include', value: '' });
            renderFilterRules();
        }

        function removeFilterRule(id) {
            filterRules = filterRules.filter(r => r.id !== id);
            renderFilterRules();
        }

        function renderFilterRules() {
            const container = document.getElementById('filterRulesContainer');
            container.innerHTML = filterRules.map(r => `
                <div class="filter-rule" data-rule-id="${r.id}">
                    <select onchange="updateFilterRule(${r.id}, 'field', this.value)">
                        <option value="all" ${r.field === 'all' ? 'selected' : ''}>All</option>
                        <option value="task_name" ${r.field === 'task_name' ? 'selected' : ''}>Task Name</option>
                        <option value="task_note" ${r.field === 'task_note' ? 'selected' : ''}>Task Note</option>
                        <option value="task_id" ${r.field === 'task_id' ? 'selected' : ''}>Task ID</option>
                    </select>
                    <select onchange="updateFilterRule(${r.id}, 'mode', this.value)">
                        <option value="include" ${r.mode === 'include' ? 'selected' : ''}>åŒ…å«</option>
                        <option value="exclude" ${r.mode === 'exclude' ? 'selected' : ''}>æ’é™¤</option>
                    </select>
                    <input type="text" value="${escapeHtml(r.value)}" placeholder="é—œéµå­—..."
                        oninput="updateFilterRule(${r.id}, 'value', this.value)"
                        onkeydown="if(event.key==='Enter') applyFilters()">
                    <button class="remove-rule-btn" onclick="removeFilterRule(${r.id})">Ã—</button>
                </div>
            `).join('');
        }

        function updateFilterRule(id, key, value) {
            const rule = filterRules.find(r => r.id === id);
            if (rule) rule[key] = value;
        }

        function compareVersions(v1, v2) {
            // Semver-like comparison: split by '.', compare each part numerically
            const p1 = String(v1).split('.').map(Number);
            const p2 = String(v2).split('.').map(Number);
            const len = Math.max(p1.length, p2.length);
            for (let i = 0; i < len; i++) {
                const a = p1[i] || 0;
                const b = p2[i] || 0;
                if (a < b) return -1;
                if (a > b) return 1;
            }
            return 0;
        }

        function applyFilters() {
            const includeRules = filterRules.filter(r => r.mode === 'include' && r.value.trim());
            const excludeRules = filterRules.filter(r => r.mode === 'exclude' && r.value.trim());
            const logic = document.querySelector('input[name="filterLogic"]:checked').value; // 'or' or 'and'

            const versionOp = document.getElementById('versionOp').value;
            const versionVal = document.getElementById('versionValue').value.trim();

            const hasAnyFilter = includeRules.length > 0 || excludeRules.length > 0 || (versionOp && versionVal);

            if (!hasAnyFilter) {
                filteredGroups = null;
                renderSampleSelector();
                renderAll();
                updateFilterBadge();
                return;
            }

            filteredGroups = new Set();

            allGroups.forEach(g => {
                const d = g.activeData || g.latestData;

                // Check keyword rules
                const matchesRule = (rule) => {
                    const keyword = rule.value.trim().toLowerCase();
                    if (!keyword) return false;
                    if (rule.field === 'all') {
                        return (d['Task Name'] || '').toLowerCase().includes(keyword)
                            || (d['Task Note'] || '').toLowerCase().includes(keyword)
                            || (d['Task ID'] || '').toLowerCase().includes(keyword);
                    } else if (rule.field === 'task_name') {
                        return (d['Task Name'] || '').toLowerCase().includes(keyword);
                    } else if (rule.field === 'task_note') {
                        return (d['Task Note'] || '').toLowerCase().includes(keyword);
                    } else if (rule.field === 'task_id') {
                        return (d['Task ID'] || '').toLowerCase().includes(keyword);
                    }
                    return false;
                };

                // Include check
                let passInclude = true;
                if (includeRules.length > 0) {
                    if (logic === 'or') {
                        passInclude = includeRules.some(matchesRule);
                    } else {
                        passInclude = includeRules.every(matchesRule);
                    }
                }

                // Exclude check (AND: any match => exclude)
                let passExclude = true;
                if (excludeRules.length > 0) {
                    passExclude = !excludeRules.some(matchesRule);
                }

                // Version check
                let passVersion = true;
                if (versionOp && versionVal) {
                    const taskVersion = d['Viva Version'];
                    if (!taskVersion || taskVersion === 'N/A') {
                        passVersion = false;
                    } else {
                        // Strip leading 'v' if present
                        const tv = taskVersion.replace(/^v/i, '');
                        const fv = versionVal.replace(/^v/i, '');
                        const cmp = compareVersions(tv, fv);
                        if (versionOp === 'eq') passVersion = cmp === 0;
                        else if (versionOp === 'gte') passVersion = cmp >= 0;
                        else if (versionOp === 'gt') passVersion = cmp > 0;
                        else if (versionOp === 'lte') passVersion = cmp <= 0;
                        else if (versionOp === 'lt') passVersion = cmp < 0;
                    }
                }

                if (passInclude && passExclude && passVersion) {
                    filteredGroups.add(g.groupName);
                }
            });

            renderSampleSelector();
            renderAll();
            updateFilterBadge();
        }

        function clearFilters() {
            filterRules = [];
            filterRuleIdCounter = 0;
            document.getElementById('versionOp').value = '';
            document.getElementById('versionValue').value = '';
            document.querySelector('#logicOr').checked = true;
            filteredGroups = null;
            addFilterRule();
            renderSampleSelector();
            renderAll();
            updateFilterBadge();
        }

        function updateFilterBadge() {
            const btn = document.getElementById('filterToggleBtn');
            const activeCount = filterRules.filter(r => r.value.trim()).length
                + (document.getElementById('versionOp').value && document.getElementById('versionValue').value.trim() ? 1 : 0);
            if (filteredGroups !== null && activeCount > 0) {
                btn.innerHTML = `âš™ ç¯©é¸ <span class="filter-active-count">${activeCount}</span>`;
            } else {
                btn.innerHTML = 'âš™ ç¯©é¸';
            }
        }

        // ==========================================
        // DB Info Bar
        // ==========================================
        function showDbInfo(fileName) {
            const bar = document.getElementById('dbInfoBar');
            const totalRuns = Object.keys(allRunDataMap).length;
            const totalGroups = allGroups.length;

            // Collect all finish times and VIVA versions
            let allDates = [];
            let vivaVersions = new Set();
            allGroups.forEach(g => {
                g.runs.forEach(r => {
                    if (r.finish_date && r.finish_date !== 'N/A') allDates.push(r.finish_date);
                    else if (r.start_date && r.start_date !== 'N/A') allDates.push(r.start_date);
                    if (r.viva_version && r.viva_version !== 'N/A') vivaVersions.add(r.viva_version);
                });
            });

            allDates.sort();
            const earliest = allDates.length > 0 ? allDates[0] : 'N/A';
            const latest = allDates.length > 0 ? allDates[allDates.length - 1] : 'N/A';
            const versions = vivaVersions.size > 0 ? Array.from(vivaVersions).sort().join(', ') : 'N/A';

            bar.innerHTML = `
                <span class="info-item"><span class="info-label">ğŸ“ æª”æ¡ˆ:</span> <span class="info-value">${escapeHtml(fileName)}</span></span>
                <span class="info-item"><span class="info-label">ğŸ“Š æ¨£æœ¬çµ„/ç­†æ•¸:</span> <span class="info-value">${totalGroups} çµ„ / ${totalRuns} ç­†</span></span>
                <span class="info-item"><span class="info-label">ğŸ“… æœ€æ—©ä»»å‹™:</span> <span class="info-value">${escapeHtml(earliest)}</span></span>
                <span class="info-item"><span class="info-label">ğŸ“… æœ€æ–°ä»»å‹™:</span> <span class="info-value">${escapeHtml(latest)}</span></span>
                <span class="info-item"><span class="info-label">ğŸ·ï¸ VIVA ç‰ˆæœ¬:</span> <span class="info-value">${escapeHtml(versions)}</span></span>
            `;
            bar.classList.add('show');
        }

        // ==========================================
        // Main entry: load .db file
        // ==========================================
        async function handleFile(e) {
            const file = e.target.files[0];
            if (!file) return;

            const overlay = document.getElementById('loadingOverlay');
            overlay.classList.add('show');

            try {
                const SQL = await initSqlJs({
                    locateFile: f => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${f}`
                });

                const buf = await file.arrayBuffer();
                const db = new SQL.Database(new Uint8Array(buf));

                parseDatabase(db);
                db.close();

                document.getElementById('sampleCount').innerText = `å·²è¼‰å…¥: ${allGroups.length} çµ„ / ${Object.keys(allRunDataMap).length} ç­†`;
                showDbInfo(file.name);
                renderSampleSelector();
                renderAll();
            } catch (err) {
                alert('è®€å–è³‡æ–™åº«å¤±æ•—: ' + err.message);
                console.error(err);
            } finally {
                overlay.classList.remove('show');
            }
        }

        // --- Parse SQLite database into structured data ---
        function parseDatabase(db) {
            allGroups = [];
            allRunDataMap = {};
            selectedGroups.clear();
            filteredGroups = null;

            // 1. Get all completed tasks
            const tasks = queryAll(db, `
                SELECT task_id, task_name, start_date, finish_date, status,
                       preset_id, task_note, product_name, product_lot, seq_date,
                       viva_version, preset_version
                FROM Tasks
                WHERE status = 'Completed'
                ORDER BY start_date DESC
            `);

            if (tasks.length === 0) {
                alert('è³‡æ–™åº«ä¸­æ²’æœ‰å·²å®Œæˆçš„ä»»å‹™ã€‚');
                return;
            }

            // 2. Get QC data
            const qcRows = queryAll(db, `SELECT * FROM QC_Metrics`);
            const qcMap = {};
            qcRows.forEach(r => { qcMap[r.task_id] = r; });

            // 3. Get Alignment Stats
            const alnRows = queryAll(db, `SELECT * FROM Alignment_Stats`);
            const alnMap = {};
            alnRows.forEach(r => {
                if (!alnMap[r.task_id]) alnMap[r.task_id] = [];
                alnMap[r.task_id].push(r);
            });

            // 4. Get Impurities Stats
            const impRows = queryAll(db, `SELECT * FROM Impurities_Stats`);
            const impMap = {};
            impRows.forEach(r => {
                if (!impMap[r.task_id]) impMap[r.task_id] = [];
                impMap[r.task_id].push(r);
            });

            // 5. Get BLAST Results
            const blastRows = queryAll(db, `SELECT * FROM BLAST_Results`);
            const blastMap = {};
            blastRows.forEach(r => {
                if (!blastMap[r.task_id]) blastMap[r.task_id] = [];
                blastMap[r.task_id].push(r);
            });

            // 6. Derive group name from task_id
            function deriveTaskPrefix(taskId) {
                const match = taskId.match(/^(.+)_(\d{12})$/);
                if (match) return match[1];
                return taskId;
            }

            // Build data rows for ALL completed tasks
            tasks.forEach(t => {
                const data = buildDataRow(t, qcMap[t.task_id], alnMap[t.task_id], impMap[t.task_id], blastMap[t.task_id]);
                allRunDataMap[t.task_id] = data;
            });

            // Group tasks by derived prefix
            const groupMap = {};
            tasks.forEach(t => {
                const groupKey = deriveTaskPrefix(t.task_id);
                if (!groupMap[groupKey]) groupMap[groupKey] = [];
                groupMap[groupKey].push(t);
            });

            // 7. Sort each group by start_date DESC, then build allGroups
            for (const [groupName, taskList] of Object.entries(groupMap)) {
                taskList.sort((a, b) => (b.start_date || '').localeCompare(a.start_date || ''));
                const latestTask = taskList[0];
                const latestTaskId = latestTask.task_id;
                const data = allRunDataMap[latestTaskId];

                // Override Task Name with the derived prefix
                data['Task Name'] = groupName;

                // Add run count
                data['Runs'] = taskList.length;

                const runs = taskList.map(t => ({
                    task_id: t.task_id,
                    start_date: t.start_date,
                    finish_date: t.finish_date,
                    viva_version: t.viva_version || 'N/A',
                    preset_version: t.preset_version || 'N/A',
                    isLatest: t.task_id === latestTaskId
                }));

                allGroups.push({
                    groupName,
                    latestData: data,
                    activeData: data,           // Currently displayed data (can be switched via history)
                    activeTaskId: latestTaskId,  // Currently active task_id
                    runs
                });
                selectedGroups.add(groupName);
            }

            // Also set Task Name for non-latest runs
            for (const [groupName, taskList] of Object.entries(groupMap)) {
                taskList.forEach(t => {
                    if (allRunDataMap[t.task_id]) {
                        allRunDataMap[t.task_id]['Task Name'] = groupName;
                        allRunDataMap[t.task_id]['Runs'] = taskList.length;
                    }
                });
            }

            // Sort groups alphabetically
            allGroups.sort((a, b) => a.groupName.localeCompare(b.groupName));
        }

        // --- Build a single data row from DB query results ---
        function buildDataRow(task, qc, alnArr, impArr, blastArr) {
            const data = {};

            // Meta
            data['Task Name'] = task.task_name || task.task_id;
            data['Task ID'] = task.task_id;
            data['Task Note'] = task.task_note || 'N/A';
            data['Finish Time'] = task.finish_date || 'N/A';
            data['Preset ID'] = task.preset_id || 'N/A';
            data['Preset Version'] = task.preset_version || 'N/A';
            data['Viva Version'] = task.viva_version || 'N/A';

            // QC
            const rawReadsAfter = qc ? (qc.fastp_after_reads || 1) : 1;
            if (qc) {
                data['Total Reads(Before)'] = qc.fastp_before_reads ? parseInt(qc.fastp_before_reads).toLocaleString() : 'N/A';
                data['Total Reads(After)'] = qc.fastp_after_reads ? parseInt(qc.fastp_after_reads).toLocaleString() : 'N/A';
                data['Q30 Rate'] = qc.fastp_after_q30 != null ? (parseFloat(qc.fastp_after_q30) * 100).toFixed(2) + '%' : 'N/A';
                data['Dup %'] = qc.duplication_rate != null ? (parseFloat(qc.duplication_rate) * 100).toFixed(2) + '%' : 'N/A';
                data['Mean length R1'] = qc.mean_length_r1 || '-';
                data['Mean length R2'] = qc.mean_length_r2 || '-';

                // Host
                if (qc.remove_host_name) {
                    const hostKey = qc.remove_host_name;
                    data[`Host_${hostKey}`] = qc.remove_host_pct != null ? parseFloat(qc.remove_host_pct).toFixed(2) + '%' : 'N/A';
                }
            }

            // RPM helper
            const calcRPM = (count) => ((count / rawReadsAfter) * 1000000).toFixed(4);

            // Impurities
            if (impArr) {
                impArr.forEach(imp => {
                    const name = imp.impurity_name;
                    const alignerPrefix = imp.aligner === 'bowtie2' ? 'BT2' : 'BWA';

                    data[`Impurity_${alignerPrefix}_${name}_Count`] = imp.mapped_reads;
                    data[`Impurity_${alignerPrefix}_${name}_RPM`] = calcRPM(parseInt(imp.mapped_reads));
                    data[`Impurity_${alignerPrefix}_${name}_Cov`] = imp.coverage != null ? parseFloat(imp.coverage).toFixed(2) + '%' : '-';
                });
            }

            // Alignment
            if (alnArr) {
                alnArr.forEach(aln => {
                    const refName = aln.ref_header;
                    const alignerPrefix = aln.aligner === 'bowtie2' ? 'BT2' : 'BWA';

                    data[`Align_${alignerPrefix}_${refName}_RPM`] = calcRPM(parseInt(aln.mapped_reads));
                    data[`Align_${alignerPrefix}_${refName}_Cov`] = aln.coverage != null ? parseFloat(aln.coverage).toFixed(2) + '%' : '-';
                    data[`Align_${alignerPrefix}_${refName}_Dep`] = aln.mean_depth != null ? parseFloat(aln.mean_depth).toFixed(2) + 'x' : '-';
                });
            }

            // BLAST
            if (blastArr) {
                blastArr.forEach(b => {
                    data[`BLAST_${b.db_name}`] = b.hit_count;
                });
            }

            return data;
        }

        // --- Helper: run SQL query and return array of objects ---
        function queryAll(db, sql) {
            const results = [];
            try {
                const stmt = db.prepare(sql);
                while (stmt.step()) {
                    const row = stmt.getAsObject();
                    results.push(row);
                }
                stmt.free();
            } catch (e) {
                console.warn('Query error:', e.message, sql);
            }
            return results;
        }

        // ==========================================
        // Render sidebar
        // ==========================================
        function renderSampleSelector() {
            const container = document.getElementById('sampleSelector');
            container.innerHTML = allGroups.map(g => {
                const d = g.activeData || g.latestData;
                const isVisible = filteredGroups === null || filteredGroups.has(g.groupName);
                const runsBadge = g.runs.length > 1
                    ? `<span class="run-count-badge" onclick="showHistory(event, '${escapeHtml(g.groupName)}')" title="é»æ“ŠæŸ¥çœ‹æ­·å²ç´€éŒ„">${g.runs.length} æ¬¡</span>`
                    : '';
                const versionBadge = d['Viva Version'] !== 'N/A'
                    ? `<span class="version-badge">${d['Viva Version']}</span>`
                    : '';
                const activeNote = g.activeTaskId !== g.runs[0]?.task_id
                    ? `<br><span style="color:#e67e22; font-size:0.63rem">â–¸ å·²åˆ‡æ›: ${escapeHtml(g.activeTaskId)}</span>`
                    : '';
                return `
                <div class="sample-item ${isVisible ? '' : 'filtered-out'}" data-group="${escapeHtml(g.groupName)}">
                    <input type="checkbox" ${selectedGroups.has(g.groupName) ? 'checked' : ''} onchange="toggleSample('${escapeHtml(g.groupName)}')">
                    <div class="sample-info">
                        <strong>${escapeHtml(g.groupName)}</strong>${versionBadge}${runsBadge}<br>
                        <span style="color:#888">${escapeHtml(d['Task Note'])}</span><br>
                        <span style="color:#aaa; font-size:0.65rem">ä½¿ç”¨ä¸­: ${escapeHtml(g.activeTaskId || d['Task ID'])}</span>${activeNote}
                    </div>
                </div>
            `;
            }).join('');

            // Update count
            const visibleCount = filteredGroups === null ? allGroups.length : filteredGroups.size;
            document.getElementById('sampleCount').innerText = `å·²è¼‰å…¥: ${allGroups.length} çµ„ / ${Object.keys(allRunDataMap).length} ç­† | é¡¯ç¤º: ${visibleCount} çµ„`;
        }

        // ==========================================
        // History popover: now selectable
        // ==========================================
        function showHistory(event, groupName) {
            event.stopPropagation();
            const popover = document.getElementById('historyPopover');
            const group = allGroups.find(g => g.groupName === groupName);
            if (!group) return;

            const rect = event.target.getBoundingClientRect();
            popover.style.top = (rect.top) + 'px';
            popover.style.left = (rect.right + 10) + 'px';
            popover.style.position = 'fixed';

            popover.innerHTML = `
                <h6>ã€Œ${escapeHtml(groupName)}ã€åˆ†ææ­·å² (${group.runs.length} æ¬¡)</h6>
                <div style="font-size:0.68rem; color:#888; margin-bottom:8px;">é»æ“Šå¯åˆ‡æ›é¡¯ç¤ºçš„è³‡æ–™</div>
                ${group.runs.map(r => {
                const isActive = r.task_id === group.activeTaskId;
                const badgeClass = isActive ? 'badge-selected' : (r.isLatest ? 'badge-latest' : 'badge-old');
                const badgeText = isActive ? 'ä½¿ç”¨ä¸­' : (r.isLatest ? 'æœ€æ–°' : 'èˆŠç‰ˆ');
                return `
                    <div class="history-item ${isActive ? 'selected' : ''}"
                         onclick="selectHistoryRun('${escapeHtml(groupName)}', '${escapeHtml(r.task_id)}')">
                        <div>
                            <span class="${badgeClass}">${badgeText}</span>
                            <strong>${escapeHtml(r.task_id)}</strong>
                        </div>
                        <div style="text-align:right; font-size:0.68rem; color:#888;">
                            VIVA ${r.viva_version} | ${r.start_date || 'N/A'}
                        </div>
                    </div>
                `;
            }).join('')}
            `;
            popover.classList.add('show');
        }

        function selectHistoryRun(groupName, taskId) {
            const group = allGroups.find(g => g.groupName === groupName);
            if (!group) return;

            const data = allRunDataMap[taskId];
            if (!data) {
                alert('æ‰¾ä¸åˆ°è©²ç­†è³‡æ–™ï¼Œå¯èƒ½å°šæœªå¿«å–ã€‚');
                return;
            }

            // Switch active data
            group.activeData = data;
            group.activeTaskId = taskId;

            // Close popover
            document.getElementById('historyPopover').classList.remove('show');

            // Re-render
            renderSampleSelector();
            renderAll();
        }

        function toggleSample(groupName) {
            if (selectedGroups.has(groupName)) selectedGroups.delete(groupName);
            else selectedGroups.add(groupName);
            renderAll();
        }

        function toggleAllSamples(checked) {
            selectedGroups.clear();
            if (checked) {
                allGroups.forEach(g => {
                    // Only select visible groups (respecting filter)
                    if (filteredGroups === null || filteredGroups.has(g.groupName)) {
                        selectedGroups.add(g.groupName);
                    }
                });
            }
            document.querySelectorAll('#sampleSelector input[type=checkbox]').forEach(el => {
                const item = el.closest('.sample-item');
                if (item && !item.classList.contains('filtered-out')) {
                    el.checked = checked;
                }
            });
            renderAll();
        }

        // --- Compute dynamic keys from a given set of data rows ---
        function computeDynamicKeys(dataRows) {
            const dk = { Host: new Set(), Impurity: new Set(), Reference: new Set(), BLAST: new Set() };
            dataRows.forEach(row => {
                Object.keys(row).forEach(key => {
                    let m;
                    if ((m = key.match(/^Host_(.+)$/))) dk.Host.add(m[1]);
                    else if ((m = key.match(/^Impurity_(?:BWA|BT2)_(.+?)_(?:Count|RPM|Cov)$/))) dk.Impurity.add(m[1]);
                    else if ((m = key.match(/^Align_(?:BWA|BT2)_(.+?)_(?:RPM|Cov|Dep)$/))) dk.Reference.add(m[1]);
                    else if ((m = key.match(/^BLAST_(.+)$/))) dk.BLAST.add(m[1]);
                });
            });
            return dk;
        }

        // ==========================================
        // Main render
        // ==========================================
        function renderAll() {
            const container = document.getElementById('tablesContainer');

            const displayData = allGroups.filter(g => {
                if (!selectedGroups.has(g.groupName)) return false;
                if (filteredGroups !== null && !filteredGroups.has(g.groupName)) return false;
                return true;
            }).map(g => g.activeData || g.latestData);

            if (displayData.length === 0) {
                container.innerHTML = '<div class="text-center p-5 text-muted">ç„¡é¡¯ç¤ºè³‡æ–™</div>';
                return;
            }

            // Recompute dynamic keys based on currently displayed data only
            const activeDK = computeDynamicKeys(displayData);

            container.innerHTML = CATEGORIES.map(cat => {
                let cols = ['Task Name'];
                if (cat.id === 'meta' || cat.id === 'qc') cols = cat.keys;
                else if (cat.id === 'host') Array.from(activeDK.Host).forEach(k => cols.push(`Host_${k}`));
                else if (cat.id === 'impurity_bwa') Array.from(activeDK.Impurity).forEach(k => {
                    cols.push(`Impurity_BWA_${k}_Count`);
                    cols.push(`Impurity_BWA_${k}_RPM`);
                    cols.push(`Impurity_BWA_${k}_Cov`);
                });
                else if (cat.id === 'impurity_bt2') Array.from(activeDK.Impurity).forEach(k => {
                    cols.push(`Impurity_BT2_${k}_Count`);
                    cols.push(`Impurity_BT2_${k}_RPM`);
                    cols.push(`Impurity_BT2_${k}_Cov`);
                });
                else if (cat.id === 'align_bwa') Array.from(activeDK.Reference).forEach(k => {
                    cols.push(`Align_BWA_${k}_Cov`);
                    cols.push(`Align_BWA_${k}_Dep`);
                    cols.push(`Align_BWA_${k}_RPM`);
                });
                else if (cat.id === 'align_bt2') Array.from(activeDK.Reference).forEach(k => {
                    cols.push(`Align_BT2_${k}_Cov`);
                    cols.push(`Align_BT2_${k}_Dep`);
                    cols.push(`Align_BT2_${k}_RPM`);
                });
                else if (cat.id === 'blast') Array.from(activeDK.BLAST).forEach(k => cols.push(`BLAST_${k}`));

                if (cols.length <= 1 && cat.id !== 'meta' && cat.id !== 'qc') return '';

                return `
                <div class="section-card">
                    <div class="table-title"><h6>${cat.name}</h6></div>
                    <div class="table-container">
                        <table class="table table-sm table-bordered mb-0">
                            <thead><tr>${cols.map(c => `<th>${formatHeader(c)}</th>`).join('')}</tr></thead>
                            <tbody>${displayData.map(row => `<tr>${cols.map(c => {
                    const val = row[c] !== undefined ? row[c] : '<span class="empty-cell">-</span>';
                    let cls = '';
                    if (c.includes('RPM')) cls = 'rpm-val';
                    else if (c.includes('_Cov') || c.includes('_Rate') || c === 'Q30 Rate') cls = 'cov-val';
                    else cls = 'count-val';
                    return `<td class="${cls}">${val}</td>`;
                }).join('')}</tr>`).join('')}</tbody>
                        </table>
                    </div>
                </div>
            `;
            }).join('');
        }

        function formatHeader(col) {
            if (col === 'Task Name' || col === 'Task ID') return col;
            return col.replace(/Host_|Impurity_BWA_|Impurity_BT2_|Align_BWA_|Align_BT2_|BLAST_/g, '')
                .replace('_Count', ' (Reads)').replace('_RPM', ' (RPM)')
                .replace('_Cov', ' (Cov%)').replace('_Dep', ' (Depth)');
        }

        function escapeHtml(str) {
            if (!str) return '';
            return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }

        // --- CSV Export ---
        function exportAllToCSV() {
            let csv = "\uFEFF"; // BOM for Excel
            const displayData = allGroups.filter(g => {
                if (!selectedGroups.has(g.groupName)) return false;
                if (filteredGroups !== null && !filteredGroups.has(g.groupName)) return false;
                return true;
            }).map(g => g.activeData || g.latestData);

            // Recompute dynamic keys for CSV based on displayed data
            const csvDK = computeDynamicKeys(displayData);

            CATEGORIES.forEach(cat => {
                let cols = ['Task Name'];
                if (cat.id === 'meta' || cat.id === 'qc') cols = cat.keys;
                else if (cat.id === 'host') Array.from(csvDK.Host).forEach(k => cols.push(`Host_${k}`));
                else if (cat.id === 'impurity_bwa') Array.from(csvDK.Impurity).forEach(k => {
                    cols.push(`Impurity_BWA_${k}_Count`);
                    cols.push(`Impurity_BWA_${k}_RPM`);
                    cols.push(`Impurity_BWA_${k}_Cov`);
                });
                else if (cat.id === 'impurity_bt2') Array.from(csvDK.Impurity).forEach(k => {
                    cols.push(`Impurity_BT2_${k}_Count`);
                    cols.push(`Impurity_BT2_${k}_RPM`);
                    cols.push(`Impurity_BT2_${k}_Cov`);
                });
                else if (cat.id === 'align_bwa') Array.from(csvDK.Reference).forEach(k => {
                    cols.push(`Align_BWA_${k}_Cov`); cols.push(`Align_BWA_${k}_Dep`); cols.push(`Align_BWA_${k}_RPM`);
                });
                else if (cat.id === 'align_bt2') Array.from(csvDK.Reference).forEach(k => {
                    cols.push(`Align_BT2_${k}_Cov`); cols.push(`Align_BT2_${k}_Dep`); cols.push(`Align_BT2_${k}_RPM`);
                });
                else if (cat.id === 'blast') Array.from(csvDK.BLAST).forEach(k => cols.push(`BLAST_${k}`));

                if (cols.length > 1 || cat.id === 'meta') {
                    csv += `${cat.name}\n`;
                    csv += cols.map(c => `"${formatHeader(c)}"`).join(',') + "\n";
                    displayData.forEach(row => {
                        csv += cols.map(c => `"${(row[c] || '-')}"`).join(',') + "\n";
                    });
                    csv += "\n";
                }
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `NGS_DB_Report_${new Date().toISOString().slice(0, 10)}.csv`;
            link.click();
        }
    </script>
</body>

</html>